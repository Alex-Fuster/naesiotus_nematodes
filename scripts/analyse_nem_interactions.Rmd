---
title: "R Notebook"
---


```{r}
library(tidyverse)
library(readxl)
library(dplyr)
library(igraph)
library(ggplot2)
library(ggraph)
library(ggrepel)
```

Read data

```{r}
df_taxa_nem <- read.csv(here::here("data/taxa_nem_splevel.csv"))
metadata <- read_excel(here::here("../sequencing/metadata.xlsx"))[-1,]
```

What samples do not contain nematodes?

```{r}
sort(setdiff(metadata$`sample-id`, df_taxa_nem$index))
```

What negatives contain nematodes?

```{r}
unique(df_taxa_nem[df_taxa_nem$pos_neg == "negative", "species_code"])
```

Add species names to df_taxa_nem

```{r}

# Assuming the column names are the same and properly formatted, join the two dataframes
df_taxa_nem <- df_taxa_nem %>%
  # Perform a left join to add species names from metadata to df_taxa_nem
  left_join(metadata |> select("sample-id", "species"), by = c("index" = "sample-id")) %>%
  # Select only the necessary columns and add species column
  select(everything(), species)

# Check the updated dataframe
head(df_taxa_nem)
```

What species didnt amplify nematodes?

```{r}
setdiff(metadata$species, df_taxa_nem$species)
```

# Compute metaweb

Nematode abundances are averaged across samples of the same species, as these are relative abundances - ask Ian if this is correct or I should sum them. 

```{r}
# Select columns with nematode taxa and species
nematode_columns <- df_taxa_nem %>%
  select(starts_with("d__Eukaryota"), species)

# Summarize the abundance of nematode taxa by species
interaction_matrix <- nematode_columns %>%
  group_by(species) %>%
  summarise(across(starts_with("d__Eukaryota"), ~ mean(as.numeric(.), na.rm = TRUE)))


# Convert to a matrix format (rows = species, columns = nematode taxa)
interaction_matrix <- as.matrix(interaction_matrix)
rownames_snailspp <- interaction_matrix[,1]
rownames(interaction_matrix) <- rownames_snailspp
interaction_matrix <- as.matrix(interaction_matrix[,-1]) # Exclude species column from matrix conversion

# Remove the prefix "d__Eukaryota.p__Nematozoa." from the column names
colnames(interaction_matrix) <- sub("^d__Eukaryota\\.p__Nematozoa\\.", "", colnames(interaction_matrix))

# Ensure that the matrix values are numeric
interaction_matrix <- apply(interaction_matrix, 2, as.numeric)
rownames(interaction_matrix) <- rownames_snailspp

#saveRDS(interaction_matrix, here::here("output/objects/metaweb_by_nemtaxa.rds"))

```




# compute diversity per snail species

```{r}
nematode_interactions <- rowSums(interaction_matrix > 0)

# Create a dataframe to display the results
interaction_counts <- data.frame(
  species = rownames(interaction_matrix),
  nematode_interactions = nematode_interactions
)

# View the interaction counts
print(interaction_counts)
```



```{r}

# Extract taxonomic levels from column names using correct regex patterns
taxa_levels <- colnames(interaction_matrix) %>%
  tibble::enframe(name = NULL, value = "taxa") %>%
  mutate(
    class = str_extract(taxa, "(?<=c__)[^\\.]+"),
    order = str_extract(taxa, "(?<=o__)[^\\.]+"),
    family = str_extract(taxa, "(?<=f__)[^\\.]+"),
    genus = str_extract(taxa, "(?<=g__)[^\\.]+"),
    species = str_extract(taxa, "(?<=s__)[^\\.]+")
  )

# Replace missing taxonomic information (NA values) with "Unknown" for accurate counting
# taxa_levels <- taxa_levels %>%
#   mutate(across(everything(), ~ ifelse(is.na(.), "Unknown", .)))

# Add unique suffixes to "Unknown" values
taxa_levels <- taxa_levels %>%
  mutate(across(class:species, ~ ifelse(is.na(.), "Unknown", .))) %>%
  mutate(unique_id = row_number()) %>%  # Create a unique identifier for each row
  mutate(
    class = ifelse(class == "Unknown", paste0("Unknown_", unique_id), class),
    order = ifelse(order == "Unknown", paste0("Unknown_", unique_id), order),
    family = ifelse(family == "Unknown", paste0("Unknown_", unique_id), family),
    genus = ifelse(genus == "Unknown", paste0("Unknown_", unique_id), genus),
    species = ifelse(species == "Unknown", paste0("Unknown_", unique_id), species)
  ) %>%
  select(-unique_id)  # Remove the temporary unique_id column

# Adjust the taxa_levels structure to ensure it matches the columns of the matrix
taxa_levels <- as.data.frame(taxa_levels)

# Function to count unique taxa at each level for each species
count_unique_taxa <- function(matrix, taxa_levels, level) {
  apply(matrix, 1, function(row) {
    # Identify indices of non-zero values in the row
    non_zero_indices <- which(row > 0)
    
    # Select the corresponding taxonomic levels
    present_taxa <- taxa_levels[non_zero_indices, level]
    
    # Count unique taxa, omitting NAs
    unique_count <- length(unique(na.omit(present_taxa)))
    return(unique_count)
  })
}

# Count the number of unique species, genera, families, orders, and classes each snail species interacts with
nematode_species_counts <- count_unique_taxa(interaction_matrix, taxa_levels, "species")
nematode_genus_counts <- count_unique_taxa(interaction_matrix, taxa_levels, "genus")
nematode_family_counts <- count_unique_taxa(interaction_matrix, taxa_levels, "family")
nematode_order_counts <- count_unique_taxa(interaction_matrix, taxa_levels, "order")
nematode_class_counts <- count_unique_taxa(interaction_matrix, taxa_levels, "class")

# Combine into a dataframe with proper alignment
interaction_counts <- data.frame(
  species = rownames(interaction_matrix),
  nematode_species = nematode_species_counts,
  nematode_genus = nematode_genus_counts,
  nematode_family = nematode_family_counts,
  nematode_order = nematode_order_counts,
  nematode_class = nematode_class_counts
)

# View the interaction counts table
interaction_counts

#write.csv(interaction_counts,here::here("output/tables/diversity_nemtaxa_per_snailspp.csv"))

```



```{r}
# Reshape the data to long format for easier plotting
interaction_counts_long <- interaction_counts %>%
  pivot_longer(cols = starts_with("nematode"), 
               names_to = "taxonomic_level", 
               values_to = "count")

# Create grouped bar plot per snail species
# Define a more contrasting custom color palette

# Create grouped bar plot per snail species using magma palette, avoiding yellow
ggplot(interaction_counts_long, aes(x = species, y = count, fill = taxonomic_level)) +
  geom_bar(stat = "identity", position = "dodge") +  # Grouped bars
  
  # Apply the magma viridis palette, restrict the range to avoid yellow
  scale_fill_viridis_d(option = "magma", begin = 0, end = 0.8) +  # Adjust end to avoid yellow
  
  # Customize the theme
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +  # Rotate species labels for readability
  
  # Add labels and title
  labs(x = "Snail Species", 
       y = "Count",
       title = "Nematode Interactions per Taxonomic Level for Each Snail Species",
       fill = "Taxonomic Level") +
  
  coord_flip()  # Flip coordinates to make the plot horizontal

#ggsave(here::here("output/figures/barplot_nemtaxa_persnail.png"), height = 10, width = 8)


```





























```{r}
# Extract taxonomic levels from column names
taxa_levels <- colnames(interaction_matrix) %>%
  tibble::enframe(name = NULL, value = "taxa") %>%
  mutate(
    class = str_extract(taxa, "(?<=c__)[^\\.]+"),
    order = str_extract(taxa, "(?<=o__)[^\\.]+"),
    family = str_extract(taxa, "(?<=f__)[^\\.]+"),
    genus = str_extract(taxa, "(?<=g__)[^\\.]+"),
    species = str_extract(taxa, "(?<=s__)[^\\.]+")
  )

taxa_levels <- taxa_levels %>%
  mutate(across(everything(), ~ ifelse(is.na(.), "Unknown", .)))

write.csv(taxa_levels, here::here("output/tables/df_nematode_taxalevels.csv"))

```


```{r}
# Function to count unique taxa at each level for each species
count_unique_taxa <- function(matrix, taxa_levels, level) {
  apply(matrix > 0, 1, function(row) {
    unique_taxa <- taxa_levels[row, level, drop = FALSE]
    length(unique(na.omit(unique_taxa)))
  })
}

count_unique_taxa <- function(matrix, taxa_levels, level) {
  taxa_counts <- apply(matrix, 1, function(row) {
    present_taxa <- taxa_levels[row > 0, level]  # Select taxa where abundance is greater than 0
    length(unique(na.omit(present_taxa)))        # Count unique taxa, omitting NAs
  })
  return(taxa_counts)
}


# Count the number of unique species, genera, families, orders, and classes each snail species interacts with
interaction_counts <- data.frame(
  species = rownames(interaction_matrix),
  nematode_species = count_unique_taxa(interaction_matrix, taxa_levels, "species"),
  nematode_genus = count_unique_taxa(interaction_matrix, taxa_levels, "genus"),
  nematode_family = count_unique_taxa(interaction_matrix, taxa_levels, "family"),
  nematode_order = count_unique_taxa(interaction_matrix, taxa_levels, "order"),
  nematode_class = count_unique_taxa(interaction_matrix, taxa_levels, "class")
)

# View the interaction counts table
print(interaction_counts)
```

```{r}
# Extract the nematode taxa columns and the species column
nematode_columns <- df_taxa_nem %>%
  select(starts_with("c__"), species)

# Calculate the average relative abundance of each nematode taxon by species
interaction_matrix <- nematode_columns %>%
  group_by(species) %>%
  summarise(across(starts_with("c__"), ~ mean(as.numeric(.), na.rm = TRUE)))

# Convert to a matrix format (rows = species, columns = nematode taxa)
interaction_matrix_matrix <- as.matrix(interaction_matrix[,-1]) # Exclude species column for matrix conversion
rownames(interaction_matrix_matrix) <- interaction_matrix$species

# Extract taxonomic levels from column names using correct regex patterns
taxa_levels <- colnames(interaction_matrix_matrix) %>%
  tibble::enframe(name = NULL, value = "taxa") %>%
  mutate(
    class = str_extract(taxa, "(?<=c__)[^\\.]+"),
    order = str_extract(taxa, "(?<=o__)[^\\.]+"),
    family = str_extract(taxa, "(?<=f__)[^\\.]+"),
    genus = str_extract(taxa, "(?<=g__)[^\\.]+"),
    species = str_extract(taxa, "(?<=s__)[^\\.]+")
  )

# Replace missing taxonomic information (NA values) with "Unknown" for accurate counting
taxa_levels <- taxa_levels %>%
  mutate(across(everything(), ~ ifelse(is.na(.), "Unknown", .)))

# Function to count unique taxa at each level for each species
count_unique_taxa <- function(matrix, taxa_levels, level) {
  apply(matrix, 1, function(row) {
    present_taxa <- taxa_levels[row > 0, level, drop = TRUE]  # Select taxa where abundance is greater than 0
    length(unique(na.omit(present_taxa)))                     # Count unique taxa, omitting NAs
  })
}

# Ensure correct indexing of taxa levels for rows
taxa_levels <- taxa_levels[rep(1, nrow(interaction_matrix_matrix)), ]  # Ensure correct length for rows

# Count the number of unique species, genera, families, orders, and classes each snail species interacts with
interaction_counts <- data.frame(
  species = rownames(interaction_matrix_matrix),
  nematode_species = count_unique_taxa(interaction_matrix_matrix, taxa_levels, "species"),
  nematode_genus = count_unique_taxa(interaction_matrix_matrix, taxa_levels, "genus"),
  nematode_family = count_unique_taxa(interaction_matrix_matrix, taxa_levels, "family"),
  nematode_order = count_unique_taxa(interaction_matrix_matrix, taxa_levels, "order"),
  nematode_class = count_unique_taxa(interaction_matrix_matrix, taxa_levels, "class")
)

# View the interaction counts table
print(interaction_counts)
```

