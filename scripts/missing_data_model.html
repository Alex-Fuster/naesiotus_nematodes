<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.553">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Model load</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="missing_data_model_files/libs/clipboard/clipboard.min.js"></script>
<script src="missing_data_model_files/libs/quarto-html/quarto.js"></script>
<script src="missing_data_model_files/libs/quarto-html/popper.min.js"></script>
<script src="missing_data_model_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="missing_data_model_files/libs/quarto-html/anchor.min.js"></script>
<link href="missing_data_model_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="missing_data_model_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="missing_data_model_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="missing_data_model_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="missing_data_model_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Model load</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readxl)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(naniar)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cmdstanr)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bayesplot)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidybayes)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(posterior)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="compute-species-code-id" class="level2">
<h2 class="anchored" data-anchor-id="compute-species-code-id">compute species code id</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>species_names_df_raw <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data/species_names_checks.csv"</span>))</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co"># we're dropping the species with no name in this database. </span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># this indicates morphospecies which have no formal name</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>species_names_df <span class="ot">&lt;-</span> species_names_df_raw <span class="sc">%&gt;%</span> </span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">species =</span> annotated_name)  <span class="sc">%&gt;%</span> </span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(species_name <span class="sc">!=</span> <span class="st">""</span>) <span class="sc">|&gt;</span> </span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">species_code =</span> <span class="fu">as.numeric</span>(<span class="fu">factor</span>(species_name)))</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>species_code_df <span class="ot">&lt;-</span> species_names_df <span class="sc">|&gt;</span> </span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(species_name, species_code) <span class="sc">|&gt;</span> </span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>() <span class="sc">|&gt;</span> </span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(species_code)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>species_code_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                species_name species_code
1                   akamatus            1
2              albemarlensis            2
3                amastroides            3
4               approximatus            4
5               basiplicatus            5
6                      bauri            6
7                     calvus            7
8                canaliferus            8
9                 cavagnaroi            9
10         cf. albemarlensis           10
11            chemnitzioides           11
12                   darwini           12
13                       eos           13
14              eschariferus           14
15                  hirsutus           15
16                 invalidus           16
17                 jacobinus           17
18                   lycodus           18
19                nuciformis           19
20                    nucula           20
21                       nux           21
22                  ochsneri           22
23                      olla           23
24                  perrus 1           24
25              perspectivus           25
26               pinzonensis           26
27                planospira           27
28                rabidensis           28
29                 reibischi           29
30                 rugiferus           30
31                 rugulosus           31
32              sculpturatus           32
33                  simrothi           33
34                snodgrassi           34
35                 sp_nov_11           35
36                 sp_nov_14           36
37                  sp_nov_3           37
38                  sp_nov_9           38
39         sp. nov. Darwin 1           39
40          sp. nov. Pinta 2           40
41 sp. nov. Volc\xe1n Wolf 3           41
42                   tanneri           42
43                tortuganus           43
44              unifasciatus           44
45                 ustulatus           45
46                 ventrosus           46
47                     wolfi           47</code></pre>
</div>
</div>
<ul>
<li>correct “sp. nov. Volc1n Wolf 3” in the datasets</li>
</ul>
</section>
<section id="island-info" class="level2">
<h2 class="anchored" data-anchor-id="island-info">island info</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>df_island <span class="ot">&lt;-</span> <span class="fu">read_excel</span>(<span class="at">path =</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data/19july24_datalab.xlsx"</span>), <span class="at">sheet =</span> <span class="st">"island_characteristics"</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Rename the column "mean_emergence" to "island_age" in df_island</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co"># add an ID column</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>df_island <span class="ot">&lt;-</span> df_island <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">island_age =</span> mean_emergence,</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">island_area =</span> area) <span class="sc">|&gt;</span> </span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">island_code =</span> <span class="fu">as.numeric</span>(<span class="fu">as.factor</span>(island)))</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>df_island</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 15 × 8
   island min_emergence max_emergence island_age trustable_emergence island_area
   &lt;chr&gt;  &lt;chr&gt;         &lt;chr&gt;              &lt;dbl&gt; &lt;chr&gt;                     &lt;dbl&gt;
 1 Champ… NA            NA                1.9    NA                        0.233
 2 Espan… 3             3.5               3.25   yes                      64.1  
 3 Ferna… 3.5000000000… 7.0000000000…     0.0525 yes                     649.   
 4 Flore… 1.5           2.2999999999…     1.9    yes                     178.   
 5 Genov… 0.3           NA                0.3    yes                      15.4  
 6 Isabe… 0.5           0.8               0.65   yes                    4727.   
 7 March… 0.6           NA                0.6    yes                     132.   
 8 Pinta  0.7           NA                0.7    yes                      60.3  
 9 Pinzon 1.3           1.7               1.5    yes                      18.1  
10 San_C… 2.4           4                 3.2    yes                     560.   
11 Santa… 2.9           2.9               2.9    yes                      25.2  
12 Santi… 0.8           1.4               1.1    yes                     577.   
13 Gardn… 0.76          0.51              0.635  no                        2.56 
14 Rabida 1.3           1.6               1.45   yes                       5.13 
15 Santa… 1.1000000000… 2.2999999999…     1.7    yes                     987.   
# ℹ 2 more variables: trustable_area &lt;chr&gt;, island_code &lt;dbl&gt;</code></pre>
</div>
</div>
</section>
<section id="parasite-load-dataset" class="level2">
<h2 class="anchored" data-anchor-id="parasite-load-dataset">Parasite Load dataset</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>df_load_raw <span class="ot">&lt;-</span> <span class="fu">read_excel</span>(<span class="at">path =</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data/19july24_datalab.xlsx"</span>), <span class="at">sheet =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Expecting logical in J2039 / R2039C10: got 'SA01-03'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Expecting logical in J2495 / R2495C10: got 'SC00-4'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Expecting logical in J3360 / R3360C10: got 'SA01-03'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Expecting logical in J3361 / R3361C10: got 'SA01-03'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Expecting logical in J3362 / R3362C10: got 'SA01-03'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Expecting logical in J3363 / R3363C10: got 'SA01-03'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Expecting logical in J3364 / R3364C10: got 'SA01-03'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Expecting logical in J3365 / R3365C10: got 'SA01-03'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Expecting logical in J3366 / R3366C10: got 'SA01-03'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Expecting logical in J3367 / R3367C10: got 'SA01-03'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Expecting logical in J3368 / R3368C10: got 'SA01-03'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Expecting logical in J3369 / R3369C10: got 'SA01-03'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Expecting logical in J3382 / R3382C10: got 'SA01-03'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Expecting logical in J3383 / R3383C10: got 'SA01-03'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Expecting logical in J3384 / R3384C10: got 'SA01-03'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Expecting logical in J3385 / R3385C10: got 'SA01-03'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Expecting logical in J3386 / R3386C10: got 'SA01-03'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Expecting logical in J3387 / R3387C10: got 'SA01-03'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Expecting logical in J3388 / R3388C10: got 'SA01-03'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Expecting logical in J3389 / R3389C10: got 'SA01-03'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Expecting logical in J3390 / R3390C10: got 'SA01-03'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Expecting logical in J3391 / R3391C10: got 'SA01-03'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Expecting logical in J3392 / R3392C10: got 'SA01-03'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Expecting logical in J3393 / R3393C10: got 'SA01-03'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Expecting logical in J3394 / R3394C10: got 'SA01-03'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Expecting logical in J3395 / R3395C10: got 'SA01-03'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Expecting logical in J3396 / R3396C10: got 'SA01-03'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Expecting logical in J3397 / R3397C10: got 'SA01-03'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Expecting logical in J3398 / R3398C10: got 'SA01-03'</code></pre>
</div>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># df_load |&gt; glimpse()</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>df_load_raw<span class="sc">$</span>nematode_count[<span class="fu">which</span>(df_load_raw<span class="sc">$</span>nematode_count <span class="sc">==</span> <span class="st">"&gt;100"</span>)] <span class="ot">&lt;-</span> <span class="st">"100"</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>df_load_raw<span class="sc">$</span>nematode_count <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(df_load_raw<span class="sc">$</span>nematode_count)</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>df_load_rename <span class="ot">&lt;-</span> df_load_raw <span class="sc">%&gt;%</span> </span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(id, spp, nematode_count, island) <span class="sc">%&gt;%</span> </span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">species =</span> spp)</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a><span class="co"># correct species names</span></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>df_load <span class="ot">&lt;-</span> df_load_rename <span class="sc">%&gt;%</span></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(species_names_df <span class="sc">|&gt;</span> <span class="fu">select</span>(species, species_code),</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="st">"species"</span>)</span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>df_load</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3,784 × 5
   id      species  nematode_count island     species_code
   &lt;chr&gt;   &lt;chr&gt;             &lt;dbl&gt; &lt;chr&gt;             &lt;dbl&gt;
 1 sc03-40 hirsutus              1 Santa_Cruz           15
 2 sc03-40 hirsutus              1 Santa_Cruz           15
 3 sc03-40 hirsutus              1 Santa_Cruz           15
 4 sc03-40 hirsutus              0 Santa_Cruz           15
 5 sc03-40 hirsutus              0 Santa_Cruz           15
 6 sc03-40 hirsutus              0 Santa_Cruz           15
 7 sc03-40 hirsutus              0 Santa_Cruz           15
 8 sc03-40 hirsutus              0 Santa_Cruz           15
 9 sc03-35 hirsutus              0 Santa_Cruz           15
10 sc03-35 hirsutus              0 Santa_Cruz           15
# ℹ 3,774 more rows</code></pre>
</div>
</div>
</section>
<section id="island-species-information" class="level2">
<h2 class="anchored" data-anchor-id="island-species-information">Island + species information</h2>
<p>Previously we merged all the data on islands into the load dataset, but in the last bit of code above we depart from this. Here we are adding only the island code. Island level data will instead be added to the species data, since it is used in calculations at the species level:</p>
<p>HOWEVER, species-island associations are only found in the load dataset</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>sp_code_island_df <span class="ot">&lt;-</span> df_load <span class="sc">|&gt;</span> </span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(species, species_code, island) <span class="sc">|&gt;</span> </span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>() <span class="sc">|&gt;</span> </span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(df_island)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Joining with `by = join_by(island)`</code></pre>
</div>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>sp_code_island_df <span class="sc">|&gt;</span> </span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>() <span class="sc">|&gt;</span> </span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>  knitr<span class="sc">::</span><span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 7%">
<col style="width: 9%">
<col style="width: 7%">
<col style="width: 13%">
<col style="width: 13%">
<col style="width: 7%">
<col style="width: 14%">
<col style="width: 8%">
<col style="width: 10%">
<col style="width: 8%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">species</th>
<th style="text-align: right;">species_code</th>
<th style="text-align: left;">island</th>
<th style="text-align: left;">min_emergence</th>
<th style="text-align: left;">max_emergence</th>
<th style="text-align: right;">island_age</th>
<th style="text-align: left;">trustable_emergence</th>
<th style="text-align: right;">island_area</th>
<th style="text-align: left;">trustable_area</th>
<th style="text-align: right;">island_code</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">hirsutus</td>
<td style="text-align: right;">15</td>
<td style="text-align: left;">Santa_Cruz</td>
<td style="text-align: left;">1.1000000000000001</td>
<td style="text-align: left;">2.2999999999999998</td>
<td style="text-align: right;">1.7</td>
<td style="text-align: left;">yes</td>
<td style="text-align: right;">987.09</td>
<td style="text-align: left;">yes</td>
<td style="text-align: right;">13</td>
</tr>
<tr class="even">
<td style="text-align: left;">ochsneri</td>
<td style="text-align: right;">22</td>
<td style="text-align: left;">Santa_Cruz</td>
<td style="text-align: left;">1.1000000000000001</td>
<td style="text-align: left;">2.2999999999999998</td>
<td style="text-align: right;">1.7</td>
<td style="text-align: left;">yes</td>
<td style="text-align: right;">987.09</td>
<td style="text-align: left;">yes</td>
<td style="text-align: right;">13</td>
</tr>
<tr class="odd">
<td style="text-align: left;">eos</td>
<td style="text-align: right;">13</td>
<td style="text-align: left;">Santa_Cruz</td>
<td style="text-align: left;">1.1000000000000001</td>
<td style="text-align: left;">2.2999999999999998</td>
<td style="text-align: right;">1.7</td>
<td style="text-align: left;">yes</td>
<td style="text-align: right;">987.09</td>
<td style="text-align: left;">yes</td>
<td style="text-align: right;">13</td>
</tr>
<tr class="even">
<td style="text-align: left;">tanneri</td>
<td style="text-align: right;">42</td>
<td style="text-align: left;">Santa_Cruz</td>
<td style="text-align: left;">1.1000000000000001</td>
<td style="text-align: left;">2.2999999999999998</td>
<td style="text-align: right;">1.7</td>
<td style="text-align: left;">yes</td>
<td style="text-align: right;">987.09</td>
<td style="text-align: left;">yes</td>
<td style="text-align: right;">13</td>
</tr>
<tr class="odd">
<td style="text-align: left;">reibischi</td>
<td style="text-align: right;">29</td>
<td style="text-align: left;">Santa_Cruz</td>
<td style="text-align: left;">1.1000000000000001</td>
<td style="text-align: left;">2.2999999999999998</td>
<td style="text-align: right;">1.7</td>
<td style="text-align: left;">yes</td>
<td style="text-align: right;">987.09</td>
<td style="text-align: left;">yes</td>
<td style="text-align: right;">13</td>
</tr>
<tr class="even">
<td style="text-align: left;">wolfi</td>
<td style="text-align: right;">47</td>
<td style="text-align: left;">Santa_Cruz</td>
<td style="text-align: left;">1.1000000000000001</td>
<td style="text-align: left;">2.2999999999999998</td>
<td style="text-align: right;">1.7</td>
<td style="text-align: left;">yes</td>
<td style="text-align: right;">987.09</td>
<td style="text-align: left;">yes</td>
<td style="text-align: right;">13</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="brightness-data" class="level2">
<h2 class="anchored" data-anchor-id="brightness-data">Brightness data</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>df_bright_raw <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data/kraemer2019_brightness_scores.csv"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 1555 Columns: 413
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
chr  (11): specID, type, islandtype, location, allosym, spp, subtype, group,...
dbl (402): brightness, nm300, nm301, nm302, nm303, nm304, nm305, nm306, nm30...

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>df_bright <span class="ot">&lt;-</span> df_bright_raw <span class="sc">%&gt;%</span> </span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(location, spp, brightness, microhab) <span class="sc">%&gt;%</span> </span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">id =</span> location,</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">species =</span> spp) <span class="sc">%&gt;%</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(species_names_df <span class="sc">|&gt;</span> <span class="fu">select</span>(species, species_code), <span class="at">by =</span> <span class="st">"species"</span>)</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>df_bright</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1,555 × 5
   id      species     brightness microhab    species_code
   &lt;chr&gt;   &lt;chr&gt;            &lt;dbl&gt; &lt;chr&gt;              &lt;dbl&gt;
 1 SL14-01 amastroides      1635. terrestrial            3
 2 SL14-01 amastroides       487. terrestrial            3
 3 SL14-01 amastroides      2673. terrestrial            3
 4 SL14-01 amastroides      2533. terrestrial            3
 5 SL14-01 amastroides      1050. terrestrial            3
 6 SL14-01 amastroides       646. terrestrial            3
 7 SL14-01 amastroides      1503. terrestrial            3
 8 SL14-01 amastroides       496. terrestrial            3
 9 SL14-01 amastroides      1377. terrestrial            3
10 SL14-01 amastroides       903. terrestrial            3
# ℹ 1,545 more rows</code></pre>
</div>
</div>
<p>In this dataset it seems that the MAJORITY of observations don’t have a species name. Is that correct??</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>df_bright <span class="sc">|&gt;</span> <span class="fu">count</span>(species_code) <span class="sc">|&gt;</span> </span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(n))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 26 × 2
   species_code     n
          &lt;dbl&gt; &lt;int&gt;
 1           NA   529
 2           47   142
 3           43   113
 4           45    89
 5            2    81
 6           24    61
 7           29    54
 8           11    53
 9           21    48
10           44    44
# ℹ 16 more rows</code></pre>
</div>
</div>
<p>That’s a lot of data to lose!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>df_bright_noNA <span class="ot">&lt;-</span> df_bright <span class="sc">|&gt;</span> </span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>(species_code)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>df_rad_raw <span class="ot">&lt;-</span> <span class="fu">read_excel</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data/GPS RAD snails.xlsx"</span>))</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>df_rad_rename <span class="ot">&lt;-</span> df_rad_raw <span class="sc">%&gt;%</span> </span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Sample, Taxon, </span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">habitat =</span> Microhabitat, </span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">vegetation =</span> <span class="st">`</span><span class="at">Vegetation Zone</span><span class="st">`</span>)<span class="sc">%&gt;%</span> </span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">species =</span> Taxon) <span class="sc">%&gt;%</span> </span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">glimpse</span>() <span class="sc">|&gt;</span> </span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(species_names_df <span class="sc">|&gt;</span> <span class="fu">select</span>(species, species_code), <span class="at">by =</span> <span class="st">"species"</span>) <span class="sc">|&gt;</span> <span class="co"># correct species names</span></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">habitat =</span> <span class="fu">str_to_lower</span>(habitat)) <span class="sc">%&gt;%</span> </span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">habitat =</span> <span class="fu">str_replace</span>(habitat, <span class="st">"semi-arboreal"</span>, <span class="st">"arboreal"</span>)) <span class="sc">|&gt;</span> <span class="co"># Semi-Arboreal is considered arboreal</span></span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(habitat <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"arboreal"</span>, <span class="st">"terrestrial"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 501
Columns: 4
$ Sample     &lt;chr&gt; "AL05_05_02_01", "AL05_05_02_03", "AL05_11_01_05", "AL15_01…
$ species    &lt;chr&gt; "pallidus", "pallidus", "sp. nov. Alcedo 1", "hemaerodes", …
$ habitat    &lt;chr&gt; "Semi-Arboreal", "Semi-Arboreal", NA, "Semi-Arboreal", "Sem…
$ vegetation &lt;chr&gt; "Humid", "Humid", NA, "Humid", "Humid", "Humid", "Humid", N…</code></pre>
</div>
</div>
<section id="warning" class="level4">
<h4 class="anchored" data-anchor-id="warning">warning!</h4>
<p>There should be no species in this list that are not found in the master species list! However we are missing the following in the species list</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>df_rad_rename <span class="sc">|&gt;</span> </span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.na</span>(species_code))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 123 × 5
   Sample        species           habitat     vegetation species_code
   &lt;chr&gt;         &lt;chr&gt;             &lt;chr&gt;       &lt;chr&gt;             &lt;dbl&gt;
 1 AL05_05_02_01 pallidus          arboreal    Humid                NA
 2 AL05_05_02_03 pallidus          arboreal    Humid                NA
 3 AL15_01_01_07 hemaerodes        arboreal    Humid                NA
 4 AL15_01_01_08 hemaerodes        arboreal    Humid                NA
 5 AL15_02_01_01 sp. nov. Alcedo 1 terrestrial Humid                NA
 6 AL15_02_01_09 sp. nov. Alcedo 1 terrestrial Humid                NA
 7 DA15_03_01_01 sp. nov. Darwin 2 arboreal    Humid                NA
 8 DA15_04_01_01 sp. nov. Darwin 2 arboreal    Humid                NA
 9 DA15_04_01_02 sp. nov. Darwin 2 arboreal    Humid                NA
10 DA15_05_01_02 sp. nov. Darwin 2 arboreal    Humid                NA
# ℹ 113 more rows</code></pre>
</div>
</div>
<p>for now we are dropping them</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>df_rad_rename_noNA <span class="ot">&lt;-</span> df_rad_rename <span class="sc">|&gt;</span> </span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>(species_code)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>df_hab <span class="ot">&lt;-</span>  <span class="fu">bind_rows</span>(df_bright_noNA <span class="sc">|&gt;</span> </span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">select</span>(microhab, species_code),</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>                     df_rad_rename_noNA <span class="sc">|&gt;</span> </span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">select</span>(<span class="at">microhab =</span> habitat, species_code)</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span> <span class="co"># add habitat data from brightness dataset </span></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(microhab, species_code) <span class="sc">|&gt;</span> </span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">values_from =</span> n, <span class="at">names_from =</span> microhab, <span class="at">values_fill =</span> <span class="dv">0</span>) <span class="sc">|&gt;</span> </span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">total_hab =</span> terrestrial <span class="sc">+</span> arboreal)</span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>df_hab</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 38 × 4
   species_code arboreal terrestrial total_hab
          &lt;dbl&gt;    &lt;int&gt;       &lt;int&gt;     &lt;int&gt;
 1            2       86           8        94
 2            4        6           0         6
 3            5        2           0         2
 4           12       32           0        32
 5           13        4           0         4
 6           16        3           9        12
 7           19        4           0         4
 8           21       60           0        60
 9           22        4          20        24
10           28        4          28        32
# ℹ 28 more rows</code></pre>
</div>
</div>
</section>
<section id="vegetation-data" class="level3">
<h3 class="anchored" data-anchor-id="vegetation-data">Vegetation data</h3>
<p>the Rad dataset is where the data on vegetation come from</p>
<p>Previously we filtered for only the vegetation types spelled “humid” or “arid”, but now (19 August 2024) there seems to be no different spellings of these in the dataset. Were they corrected in the original spreadsheet?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>df_veg <span class="ot">&lt;-</span> df_rad_rename_noNA <span class="sc">%&gt;%</span> </span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Sample, species, </span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>         habitat, vegetation)<span class="sc">%&gt;%</span> </span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># glimpse() |&gt; </span></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(species_names_df <span class="sc">|&gt;</span> </span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>              <span class="fu">select</span>(species, species_code), <span class="at">by =</span> <span class="st">"species"</span>) <span class="sc">|&gt;</span> <span class="co"># correct species names</span></span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># glimpse() |&gt; </span></span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">vegetation =</span> <span class="fu">str_to_lower</span>(vegetation)) <span class="sc">|&gt;</span> </span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># filter(vegetation %in% c("humid", "arid")) |&gt; ## filter for only legal values -- others are typos</span></span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(species_code, vegetation) <span class="sc">|&gt;</span> </span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">values_from =</span> n, <span class="at">names_from =</span> vegetation, <span class="at">values_fill =</span> <span class="dv">0</span>) <span class="sc">|&gt;</span> </span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">total_veg =</span> humid <span class="sc">+</span> arid)</span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a>df_veg</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 34 × 4
   species_code  arid humid total_veg
          &lt;dbl&gt; &lt;int&gt; &lt;int&gt;     &lt;int&gt;
 1            1     4     0         4
 2            2     0    13        13
 3            3     4     0         4
 4            4     6     0         6
 5            5     0     2         2
 6            6     0     3         3
 7            7     4     0         4
 8            8     1     3         4
 9           11     2     0         2
10           13     0     1         1
# ℹ 24 more rows</code></pre>
</div>
</div>
</section>
</section>
<section id="summary-of-datasets" class="level2">
<h2 class="anchored" data-anchor-id="summary-of-datasets">Summary of datasets</h2>
<p>We now have all the datasets that we need to build the model.</p>
<section id="vegetation-data-1" class="level4">
<h4 class="anchored" data-anchor-id="vegetation-data-1">Vegetation data</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>df_veg <span class="sc">|&gt;</span> <span class="fu">head</span>() <span class="sc">|&gt;</span> knitr<span class="sc">::</span><span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">species_code</th>
<th style="text-align: right;">arid</th>
<th style="text-align: right;">humid</th>
<th style="text-align: right;">total_veg</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">4</td>
</tr>
<tr class="even">
<td style="text-align: right;">2</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">13</td>
<td style="text-align: right;">13</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">4</td>
</tr>
<tr class="even">
<td style="text-align: right;">4</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">6</td>
</tr>
<tr class="odd">
<td style="text-align: right;">5</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="even">
<td style="text-align: right;">6</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">3</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>This dataset contains 242 observations of 34 species.</p>
</section>
<section id="habitat-data" class="level4">
<h4 class="anchored" data-anchor-id="habitat-data">Habitat data</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>df_hab <span class="sc">|&gt;</span> <span class="fu">head</span>() <span class="sc">|&gt;</span> knitr<span class="sc">::</span><span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">species_code</th>
<th style="text-align: right;">arboreal</th>
<th style="text-align: right;">terrestrial</th>
<th style="text-align: right;">total_hab</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">2</td>
<td style="text-align: right;">86</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">94</td>
</tr>
<tr class="even">
<td style="text-align: right;">4</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">6</td>
</tr>
<tr class="odd">
<td style="text-align: right;">5</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="even">
<td style="text-align: right;">12</td>
<td style="text-align: right;">32</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">32</td>
</tr>
<tr class="odd">
<td style="text-align: right;">13</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">4</td>
</tr>
<tr class="even">
<td style="text-align: right;">16</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">9</td>
<td style="text-align: right;">12</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>This dataset contains 1268 observations of 38 species.</p>
</section>
<section id="species-and-island-data" class="level4">
<h4 class="anchored" data-anchor-id="species-and-island-data">species and island data</h4>
<p>This is the only dataset to contain one row per species with no missing species. It gives us the</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>sp_code_island_df <span class="sc">|&gt;</span> </span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>() <span class="sc">|&gt;</span> </span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>  knitr<span class="sc">::</span><span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 7%">
<col style="width: 9%">
<col style="width: 7%">
<col style="width: 13%">
<col style="width: 13%">
<col style="width: 7%">
<col style="width: 14%">
<col style="width: 8%">
<col style="width: 10%">
<col style="width: 8%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">species</th>
<th style="text-align: right;">species_code</th>
<th style="text-align: left;">island</th>
<th style="text-align: left;">min_emergence</th>
<th style="text-align: left;">max_emergence</th>
<th style="text-align: right;">island_age</th>
<th style="text-align: left;">trustable_emergence</th>
<th style="text-align: right;">island_area</th>
<th style="text-align: left;">trustable_area</th>
<th style="text-align: right;">island_code</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">hirsutus</td>
<td style="text-align: right;">15</td>
<td style="text-align: left;">Santa_Cruz</td>
<td style="text-align: left;">1.1000000000000001</td>
<td style="text-align: left;">2.2999999999999998</td>
<td style="text-align: right;">1.7</td>
<td style="text-align: left;">yes</td>
<td style="text-align: right;">987.09</td>
<td style="text-align: left;">yes</td>
<td style="text-align: right;">13</td>
</tr>
<tr class="even">
<td style="text-align: left;">ochsneri</td>
<td style="text-align: right;">22</td>
<td style="text-align: left;">Santa_Cruz</td>
<td style="text-align: left;">1.1000000000000001</td>
<td style="text-align: left;">2.2999999999999998</td>
<td style="text-align: right;">1.7</td>
<td style="text-align: left;">yes</td>
<td style="text-align: right;">987.09</td>
<td style="text-align: left;">yes</td>
<td style="text-align: right;">13</td>
</tr>
<tr class="odd">
<td style="text-align: left;">eos</td>
<td style="text-align: right;">13</td>
<td style="text-align: left;">Santa_Cruz</td>
<td style="text-align: left;">1.1000000000000001</td>
<td style="text-align: left;">2.2999999999999998</td>
<td style="text-align: right;">1.7</td>
<td style="text-align: left;">yes</td>
<td style="text-align: right;">987.09</td>
<td style="text-align: left;">yes</td>
<td style="text-align: right;">13</td>
</tr>
<tr class="even">
<td style="text-align: left;">tanneri</td>
<td style="text-align: right;">42</td>
<td style="text-align: left;">Santa_Cruz</td>
<td style="text-align: left;">1.1000000000000001</td>
<td style="text-align: left;">2.2999999999999998</td>
<td style="text-align: right;">1.7</td>
<td style="text-align: left;">yes</td>
<td style="text-align: right;">987.09</td>
<td style="text-align: left;">yes</td>
<td style="text-align: right;">13</td>
</tr>
<tr class="odd">
<td style="text-align: left;">reibischi</td>
<td style="text-align: right;">29</td>
<td style="text-align: left;">Santa_Cruz</td>
<td style="text-align: left;">1.1000000000000001</td>
<td style="text-align: left;">2.2999999999999998</td>
<td style="text-align: right;">1.7</td>
<td style="text-align: left;">yes</td>
<td style="text-align: right;">987.09</td>
<td style="text-align: left;">yes</td>
<td style="text-align: right;">13</td>
</tr>
<tr class="even">
<td style="text-align: left;">wolfi</td>
<td style="text-align: right;">47</td>
<td style="text-align: left;">Santa_Cruz</td>
<td style="text-align: left;">1.1000000000000001</td>
<td style="text-align: left;">2.2999999999999998</td>
<td style="text-align: right;">1.7</td>
<td style="text-align: left;">yes</td>
<td style="text-align: right;">987.09</td>
<td style="text-align: left;">yes</td>
<td style="text-align: right;">13</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="brightness-data-1" class="level4">
<h4 class="anchored" data-anchor-id="brightness-data-1">brightness data</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>df_bright_noNA <span class="sc">|&gt;</span> <span class="fu">head</span>() <span class="sc">|&gt;</span> knitr<span class="sc">::</span><span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">id</th>
<th style="text-align: left;">species</th>
<th style="text-align: right;">brightness</th>
<th style="text-align: left;">microhab</th>
<th style="text-align: right;">species_code</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">SL14-01</td>
<td style="text-align: left;">amastroides</td>
<td style="text-align: right;">1634.9636</td>
<td style="text-align: left;">terrestrial</td>
<td style="text-align: right;">3</td>
</tr>
<tr class="even">
<td style="text-align: left;">SL14-01</td>
<td style="text-align: left;">amastroides</td>
<td style="text-align: right;">487.3284</td>
<td style="text-align: left;">terrestrial</td>
<td style="text-align: right;">3</td>
</tr>
<tr class="odd">
<td style="text-align: left;">SL14-01</td>
<td style="text-align: left;">amastroides</td>
<td style="text-align: right;">2673.3929</td>
<td style="text-align: left;">terrestrial</td>
<td style="text-align: right;">3</td>
</tr>
<tr class="even">
<td style="text-align: left;">SL14-01</td>
<td style="text-align: left;">amastroides</td>
<td style="text-align: right;">2533.3980</td>
<td style="text-align: left;">terrestrial</td>
<td style="text-align: right;">3</td>
</tr>
<tr class="odd">
<td style="text-align: left;">SL14-01</td>
<td style="text-align: left;">amastroides</td>
<td style="text-align: right;">1049.5718</td>
<td style="text-align: left;">terrestrial</td>
<td style="text-align: right;">3</td>
</tr>
<tr class="even">
<td style="text-align: left;">SL14-01</td>
<td style="text-align: left;">amastroides</td>
<td style="text-align: right;">645.7658</td>
<td style="text-align: left;">terrestrial</td>
<td style="text-align: right;">3</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>all_spp_arbor <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"stan/all_spp_arbor.stan"</span>))</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>all_spp_arbor</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<div class="sourceCode" id="cb62"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> {</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> N_spp;</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">array</span>[N_spp] <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>, <span class="kw">upper</span>=N_spp&gt; sp_id;</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">// habitat data</span></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> N_habitat;</span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">array</span>[N_habitat] <span class="dt">int</span> habitat_arboreal;   <span class="co">// Total counts of arid habitat for each species</span></span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">array</span>[N_habitat] <span class="dt">int</span> total_hab;  <span class="co">//total counts of habitat (arboreal or terrestrial)</span></span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">array</span>[N_habitat] <span class="dt">int</span> sp_index_hab; </span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a><span class="kw">parameters</span> {</span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> mu_arboreal;</span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; sd_arboreal;</span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[N_spp] arboreal_prob_logit;</span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb62-16"><a href="#cb62-16" aria-hidden="true" tabindex="-1"></a><span class="kw">transformed parameters</span> {</span>
<span id="cb62-17"><a href="#cb62-17" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[N_spp] arboreal_prob = inv_logit(arboreal_prob_logit);</span>
<span id="cb62-18"><a href="#cb62-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb62-19"><a href="#cb62-19" aria-hidden="true" tabindex="-1"></a><span class="kw">model</span> {</span>
<span id="cb62-20"><a href="#cb62-20" aria-hidden="true" tabindex="-1"></a>  mu_arboreal ~ std_normal();</span>
<span id="cb62-21"><a href="#cb62-21" aria-hidden="true" tabindex="-1"></a>  sd_arboreal ~ exponential(<span class="dv">1</span>);</span>
<span id="cb62-22"><a href="#cb62-22" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Hierarchical priors for the probabilities</span></span>
<span id="cb62-23"><a href="#cb62-23" aria-hidden="true" tabindex="-1"></a>  arboreal_prob_logit ~ normal(mu_arboreal, sd_arboreal);</span>
<span id="cb62-24"><a href="#cb62-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb62-25"><a href="#cb62-25" aria-hidden="true" tabindex="-1"></a>  habitat_arboreal ~ binomial_logit(total_hab, arboreal_prob_logit[sp_index_hab]);</span>
<span id="cb62-26"><a href="#cb62-26" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>all_spp_arbor_samp <span class="ot">&lt;-</span> all_spp_arbor<span class="sc">$</span><span class="fu">sample</span>(</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> <span class="fu">list</span>(</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">N_spp =</span> <span class="fu">nrow</span>(sp_code_island_df),</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">sp_id =</span> sp_code_island_df<span class="sc">$</span>species_code,</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">N_habitat =</span> <span class="fu">nrow</span>(df_hab),</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">habitat_arboreal =</span> df_hab<span class="sc">$</span>arboreal,</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_hab =</span> df_hab<span class="sc">$</span>total_hab,</span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">sp_index_hab =</span> df_hab<span class="sc">$</span>species_code</span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a><span class="at">chains =</span> <span class="dv">4</span>, <span class="at">parallel_chains =</span> <span class="dv">4</span>, <span class="at">refresh =</span> <span class="dv">0</span></span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 parallel chains...

Chain 1 finished in 0.2 seconds.
Chain 2 finished in 0.2 seconds.
Chain 3 finished in 0.2 seconds.
Chain 4 finished in 0.2 seconds.

All 4 chains finished successfully.
Mean chain execution time: 0.2 seconds.
Total execution time: 0.3 seconds.</code></pre>
</div>
</div>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>