---
title: "R Notebook"
output: html_notebook
---

```{r setup-packages}
#| message: false
#| warning: false
library(tidyverse)
library(readxl)
library(naniar)
library(cmdstanr)
library(bayesplot)
library(tidybayes)
library(posterior)
library(ggpubr)
library(phytools)
library(ape)

```

parameters for plotting

```{r}
my_theme<-theme(axis.text=element_text(size=12),
        axis.title = element_text(size = 14),
        legend.text=element_text(size=10),
        legend.title = element_text(size=12),
        plot.title = element_text(face="bold",size=14,margin=margin(0,0,20,0),hjust = 0.5),
        axis.title.y = element_text(hjust = 0.5),
        axis.title.x = element_text(hjust = 0.5))
```


## compute species code id

```{r}
species_names_df_raw <- read.csv(here::here("data/species_names_checks.csv"))

# we're dropping the species with no name in this database. 
# this indicates morphospecies which have no formal name
species_names_df <- species_names_df_raw %>% 
  rename(species = annotated_name)  %>% 
  filter(species_name != "") |> 
  mutate(species_code = as.numeric(factor(species_name)))

species_code_df <- species_names_df |> 
  select(species_name, species_code) |> 
  distinct() |> 
  arrange(species_code)

species_code_df
```



## island info

```{r}
df_island <- read_excel(path = here::here("data/19july24_datalab.xlsx"), sheet = "island_characteristics")

# Rename the column "mean_emergence" to "island_age" in df_island
# add an ID column
df_island <- df_island %>% rename(island_age = mean_emergence,
                                  island_area = area) |> 
  mutate(island_code = as.numeric(as.factor(island)))

df_island

```

## Parasite Load dataset

```{r}
df_load_raw <- read_excel(path = here::here("data/19july24_datalab.xlsx"), sheet = 3)

df_load_raw$nematode_count[which(df_load_raw$nematode_count == ">100")] <- "100"
df_load_raw$nematode_count <- as.numeric(df_load_raw$nematode_count)

df_load_rename <- df_load_raw %>% 
  select(id, spp, nematode_count, island) %>% 
  rename(species = spp)

# correct species names
df_load <- df_load_rename %>%
  left_join(species_names_df |> select(species, species_code),
            by = "species") |> 
  left_join(df_island |> select(island, island_code),
            by = "island")
df_load

```

## Island + species information

Previously we merged all the data on islands into the load dataset, but in the last bit of code above we depart from this.
Here we are adding only the island code. 
Island level data will instead be added to the species data, since it is used in calculations at the species level:

HOWEVER, species-island associations are only found in the load dataset

```{r}
sp_code_island_df <- df_load |> 
  select(species, species_code, island, island_code) |> 
  distinct() |> 
  left_join(df_island) |> 
  left_join(species_names_df |> select(species_name, species_code)) |> 
  distinct()

sp_code_island_df |> 
  head() |> 
  knitr::kable()
```

## Brightness data

```{r}

df_bright_raw <- read_csv(here::here("data/kraemer2019_brightness_scores.csv"))
df_bright <- df_bright_raw %>% 
  select(location, spp, brightness, microhab) %>% 
  rename(id = location,
         species = spp) %>%
  left_join(species_names_df |> select(species, species_code), by = "species")

df_bright


```

In this dataset it seems that the MAJORITY of observations don't have a species name. 
Is that correct??

```{r}
df_bright |> count(species_code) |> 
  arrange(desc(n))
```

That's a lot of data to lose! 

```{r}
df_bright_noNA <- df_bright |> 
  drop_na(species_code)
```



```{r}
df_rad_raw <- read_excel(here::here("data/GPS RAD snails.xlsx"))
df_rad_rename <- df_rad_raw %>% 
  select(Sample, Taxon, 
         habitat = Microhabitat, 
         vegetation = `Vegetation Zone`)%>% 
  rename(species = Taxon) %>% 
  glimpse() |> 
  left_join(species_names_df |> select(species, species_code), by = "species") |> # correct species names
  mutate(habitat = str_to_lower(habitat)) %>% 
  mutate(habitat = str_replace(habitat, "semi-arboreal", "arboreal")) |> # Semi-Arboreal is considered arboreal
  filter(habitat %in% c("arboreal", "terrestrial"))
```


#### warning! 

There should be no species in this list that are not found in the master species list! 
However we are missing the following in the species list

```{r}
df_rad_rename |> 
  filter(is.na(species_code))
```


for now we are dropping them

```{r}
df_rad_rename_noNA <- df_rad_rename |> 
  drop_na(species_code)
```



```{r}
df_hab <-  bind_rows(df_bright_noNA |> 
                       select(microhab, species_code),
                     df_rad_rename_noNA |> 
                       select(microhab = habitat, species_code)
) |> # add habitat data from brightness dataset 
  count(microhab, species_code) |> 
  pivot_wider(values_from = n, names_from = microhab, values_fill = 0) |> 
  mutate(total_hab = terrestrial + arboreal)

df_hab
```

### Vegetation data

the Rad dataset is where the data on vegetation come from 

Previously we filtered for only the vegetation types spelled "humid" or "arid", but now (19 August 2024)
there seems to be no different spellings of these in the dataset. 
Were they corrected in the original spreadsheet?


```{r}

df_veg <- df_rad_rename_noNA %>% 
  select(Sample, species, 
         habitat, vegetation)%>% 
  # glimpse() |> 
  left_join(species_names_df |> 
              select(species, species_code), by = "species") |> # correct species names
  # glimpse() |> 
  mutate(vegetation = str_to_lower(vegetation)) |> 
  # filter(vegetation %in% c("humid", "arid")) |> ## filter for only legal values -- others are typos
  count(species_code, vegetation) |> 
  pivot_wider(values_from = n, names_from = vegetation, values_fill = 0) |> 
  mutate(total_veg = humid + arid)

df_veg

```

## Summary of datasets

We now have all the datasets that we need to build the model. 

#### Vegetation data

```{r}
df_veg |> head() |> knitr::kable()
```

This dataset contains `r sum(df_veg$total_veg)` observations of `r nrow(df_veg)` species.

#### Habitat data

```{r}
df_hab |> head() |> knitr::kable()
```

This dataset contains `r sum(df_hab$total_hab)` observations of `r nrow(df_hab)` species.

#### species and island data

This is the only dataset to contain one row per species with no missing species. It gives us the 

```{r}
sp_code_island_df |> 
  head() |> 
  knitr::kable()
```

#### brightness data

```{r}
df_bright_noNA |> head() |> knitr::kable()
```


#### load data


```{r}

df_load |> head() |> knitr::kable()
```




## Negative binomial model non-informed priors neither brightness nor load


```{r}
#| class-output: stan
load_nbinom_unconstr <- cmdstan_model(here::here("stan/load_nbinom_unconstr.stan"),
                                          pedantic = TRUE)
```



```{r}

# Data code including phylogenetic covariance matrix
unconstr_brightload_samp <- load_nbinom_unconstr$sample(
  data = list(
  N_spp = nrow(sp_code_island_df),  # Number of species (47)
  N_island = max(sp_code_island_df$island_code),
  sp_id = sp_code_island_df$species_code,
  island_area = sp_code_island_df$island_area,
  island_age = sp_code_island_df$island_age,
  island_index_spp = sp_code_island_df$island_code,
  
  # Habitat data
  N_habitat = nrow(df_hab),
  habitat_arboreal = df_hab$arboreal,
  total_hab = df_hab$total_hab,
  sp_index_hab = df_hab$species_code,
  
  # Vegetation zone data
  N_veg = nrow(df_veg),
  veg_arid = df_veg$arid,
  total_veg = df_veg$total_veg,
  sp_index_veg = df_veg$species_code,
  
  # Brightness data
  N_bright = nrow(df_bright_noNA), 
  brightness_obs = df_bright_noNA$brightness,
  sp_index_bright = df_bright_noNA$species_code,
  
  # Nematode load data
  N_load = nrow(df_load),  # Total observations for nematode load
  nematode_count = df_load$nematode_count,
  sp_index_load = df_load$species_code,  # Use species_code from df_load
  island_index_load = df_load$island_code  # Use island_code from df_load
  
),
  chains = 10, parallel_chains = 10, refresh = 0,
iter_sampling = 500,
output_dir = here::here("output/models/missing_data_load_nbinom_unconstr/model_output")
)



```

```{r}
# read in the model from above
unconstr_brightload_samp <- as_cmdstan_fit(dir(here::here("output/models/missing_data_load_nbinom_unconstr/model_output"), full.names = TRUE))
```



```{r}

unconstr_brightload_samp$diagnostic_summary()
unconstr_brightload_samp$summary()

```

```{r}
# Extract posterior samples
posterior_samples <- unconstr_brightload_samp$draws()
posterior_df <- as_draws_df(posterior_samples)

# mcmc_areas(
#   posterior_df,
#   pars = vars(starts_with("slope")),
#   prob = 0.8  
# )

# Define the number of prior samples to match the posterior size
n_prior_samples <- nrow(posterior_df)

# Generate prior samples for each parameter
set.seed(123)  # For reproducibility
priors <- tibble(
  slope_arbor_bright = rnorm(n_prior_samples, 0, 0.5),
  slope_arid_bright = rnorm(n_prior_samples, 0, 0.5),
  slope_age_bright = rnorm(n_prior_samples, 0, 0.5),
  slope_area_bright = rnorm(n_prior_samples, 0, 0.5),
  slope_bright_load = rnorm(n_prior_samples, 0, 0.5),
  slope_arbor_load = rnorm(n_prior_samples, 0, 0.5),
  slope_arid_load = rnorm(n_prior_samples, 0, 0.5),
  slope_age_load = rnorm(n_prior_samples, 0, 0.5),
  slope_area_load = rnorm(n_prior_samples, 0, 0.5)
)

# Reshape prior samples to long format
priors_long <- priors %>%
  pivot_longer(everything(), names_to = "parameter", values_to = "value") %>%
  mutate(type = "Prior")

# Reshape posterior samples to long format
posterior_long <- posterior_df %>%
  select(starts_with("slope")) %>%
  pivot_longer(everything(), names_to = "parameter", values_to = "value") %>%
  mutate(type = "Posterior")

# Combine prior and posterior data
combined_data <- bind_rows(priors_long, posterior_long)


# Plot posteriors with priors overlaid
ggplot(combined_data, aes(x = value, fill = type)) +
  geom_density(alpha = 0.5) +
  facet_wrap(~parameter, scales = "free", ncol = 2) +
  scale_fill_manual(values = c("Prior" = "red", "Posterior" = "blue")) +
  theme_minimal() +
  labs(
    title = "unconstr_brightload_samp",
    x = "Parameter Values",
    y = "Density"
  ) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "black") +  
  coord_cartesian(xlim = c(-2, 2))  +
  theme(legend.position = "right")+
  my_theme

#ggsave(here::here("output/models/missing_data_load_nbinom_unconstr/priors_posteriors.png"), height = 10, width = 8)
```






## Negative binomial model constrained priors for brightness


```{r}
#| class-output: stan
load_nbinom_constr <- cmdstan_model(here::here("stan/load_nbinom_constr.stan"),
                                          pedantic = TRUE)
```



```{r}

# Data code including phylogenetic covariance matrix
constr_brightload_samp <- load_nbinom_constr$sample(
  data = list(
  N_spp = nrow(sp_code_island_df),  # Number of species (47)
  N_island = max(sp_code_island_df$island_code),
  sp_id = sp_code_island_df$species_code,
  island_area = sp_code_island_df$island_area,
  island_age = sp_code_island_df$island_age,
  island_index_spp = sp_code_island_df$island_code,
  
  # Habitat data
  N_habitat = nrow(df_hab),
  habitat_arboreal = df_hab$arboreal,
  total_hab = df_hab$total_hab,
  sp_index_hab = df_hab$species_code,
  
  # Vegetation zone data
  N_veg = nrow(df_veg),
  veg_arid = df_veg$arid,
  total_veg = df_veg$total_veg,
  sp_index_veg = df_veg$species_code,
  
  # Brightness data
  N_bright = nrow(df_bright_noNA), 
  brightness_obs = df_bright_noNA$brightness,
  sp_index_bright = df_bright_noNA$species_code,
  
  # Nematode load data
  N_load = nrow(df_load),  # Total observations for nematode load
  nematode_count = df_load$nematode_count,
  sp_index_load = df_load$species_code,  # Use species_code from df_load
  island_index_load = df_load$island_code  # Use island_code from df_load
  
),
  chains = 10, parallel_chains = 10, refresh = 0,
iter_sampling = 500,
output_dir = here::here("output/models/missing_data_load_nbinom_constr/model_output")
)



```

```{r}
# read in the model from above
constr_brightload_samp <- as_cmdstan_fit(dir(here::here("output/models/missing_data_load_nbinom_constr/model_output"), full.names = TRUE))
```



```{r}

constr_brightload_samp$diagnostic_summary()
constr_brightload_samp$summary()

```

```{r}
# Extract posterior samples
posterior_samples <- constr_brightload_samp$draws()
posterior_df <- as_draws_df(posterior_samples)

# mcmc_areas(
#   posterior_df,
#   pars = vars(starts_with("slope")),
#   prob = 0.8  
# )

# Define the number of prior samples to match the posterior size
n_prior_samples <- nrow(posterior_df)

# Generate prior samples for each parameter
set.seed(123)  # For reproducibility
priors <- tibble(
  slope_arbor_bright = rnorm(n_prior_samples, 0.64, 0.5),
  slope_arid_bright = rnorm(n_prior_samples, 0, 0.5),
  slope_age_bright = rnorm(n_prior_samples, 0, 0.5),
  slope_area_bright = rnorm(n_prior_samples, 0, 0.5),
  slope_bright_load = rnorm(n_prior_samples, 0, 0.5),
  slope_arbor_load = rnorm(n_prior_samples, 0, 0.5),
  slope_arid_load = rnorm(n_prior_samples, 0, 0.5),
  slope_age_load = rnorm(n_prior_samples, 0, 0.5),
  slope_area_load = rnorm(n_prior_samples, 0, 0.5)
)

# Reshape prior samples to long format
priors_long <- priors %>%
  pivot_longer(everything(), names_to = "parameter", values_to = "value") %>%
  mutate(type = "Prior")

# Reshape posterior samples to long format
posterior_long <- posterior_df %>%
  select(starts_with("slope")) %>%
  pivot_longer(everything(), names_to = "parameter", values_to = "value") %>%
  mutate(type = "Posterior")

# Combine prior and posterior data
combined_data <- bind_rows(priors_long, posterior_long)


# Plot posteriors with priors overlaid
ggplot(combined_data, aes(x = value, fill = type)) +
  geom_density(alpha = 0.5) +
  facet_wrap(~parameter, scales = "free", ncol = 2) +
  scale_fill_manual(values = c("Prior" = "red", "Posterior" = "blue")) +
  theme_minimal() +
  labs(
    title = "unconstr_brightload_samp",
    x = "Parameter Values",
    y = "Density"
  ) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "black") +  
  coord_cartesian(xlim = c(-2, 2))  +
  theme(legend.position = "right")+
  my_theme

#ggsave(here::here("output/models/missing_data_load_nbinom_constr/priors_posteriors.png"), height = 10, width = 8)
```