---
title: "Analyses"
output: html_notebook
---


DOUBT NAMES JOHN

Jacobinus (in my load dataset)
Jacobi (in other datasets)
Olla Jacobinus (?)

```{r}
library(dplyr)
library(ggplot2)# Load the ape package
library(ape)
library(readxl)
library(tidyr)
library(ggpubr)
library(ade4)
library(vegan)
library(stringr)
library(brms)
library(dplyr)
library(tidyverse)
library(cmdstanr)
```


parameters for plotting

```{r}
my_theme<-theme(axis.text=element_text(size=12),
        axis.title = element_text(size = 14),
        legend.text=element_text(size=10),
        legend.title = element_text(size=12),
        plot.title = element_text(face="bold",size=14,margin=margin(0,0,20,0),hjust = 0.5),
        axis.title.y = element_text(hjust = 0.5),
        axis.title.x = element_text(hjust = 0.5))
```


# df load

```{r}
df_load <- read_excel("04april24_datalab.xlsx", sheet = 3)
df_load$nematode_count[which(df_load$nematode_count == ">100")] <- "100"
df_load$nematode_count <- as.numeric(df_load$nematode_count)

df_load <- df_load %>% 
  select(id, spp, nematode_count) %>% 
  rename(species = spp)

df_load
```

### df mean load


```{r}

df_meanload <- df_load %>%
  group_by(spp) %>%
  summarise(n = n(),
            mean_load = mean(nematode_count, na.rm = TRUE),
            sd_load = sd(nematode_count, na.rm = TRUE)) %>%
  arrange(desc(mean_load))

colnames(df_meanload) = c("species", "n" ,"mean_load", "sd_load")

df_totals <- data.frame("n" = sum(df_meanload$n),
           "mean_load" = mean(df_meanload$mean_load),
           "sd_load" = mean(df_meanload$sd_load))

df_meanload <- bind_rows(df_meanload, df_totals)

df_meanload$mean_load <- round(df_meanload$mean_load, 1)
df_meanload$sd_load <- round(df_meanload$sd_load, 1)

df_meanload

#write.csv(df_load, "output/df_load.csv")

```






# habitat data


### Habitat data from Kraemer 2019 database

```{r}
df_kraemer <- read.csv("kraemer2019/kraemer2019_brightness_scores.csv")

df_kraemer <- df_kraemer %>% 
  select(location, spp, microhab) %>% 
  rename(id = location,
         species = spp,
         habitat = microhab)

df_kraemer

```


### habitat data from RAD sequences database

```{r}
df_rad <- read_excel("GPS RAD snails.xlsx")
df_rad <- df_rad %>% 
  select(Sample, Taxon, Microhabitat) %>% 
  rename(id = Sample,
         species = Taxon,
         habitat = Microhabitat)

# Semi-Arboreal is considered arboreal
df_rad <- df_rad %>%
  mutate(habitat = str_replace(habitat, "Semi-Arboreal", "arboreal"))

df_rad <- df_rad %>%
  mutate(habitat = str_to_lower(habitat)) %>% 
  filter(habitat %in% c("arboreal", "terrestrial"))

df_rad
  
```


### Merge data to obtain single habitat database

```{r}
# Remove rows from df_rad that have matching ids in df_kraemer
df_rad_filtered <- anti_join(df_rad, df_kraemer, by = "id")

# Combine df_kraemer with the filtered df_rad
df_habitat <- bind_rows(df_kraemer, df_rad_filtered)

df_habitat
```


Names checks

```{r}
df_habitat[which(df_habitat$species == "albermarlensis"),] <- "albemarlensis"
df_habitat[which(df_habitat$species == "cf. albemarlensis"),] <- "albemarlensis"

df_habitat[which(df_habitat$species == "ustulatus pallescens"),] <- "ustulatus"
df_habitat[which(df_habitat$species == "ustulatus phlegonis"),] <- "ustulatus"
df_habitat[which(df_habitat$species == "ustulatus mahogany"),] <- "ustulatus"

df_habitat[which(df_habitat$species == "invalidus 1"),] <- "invalidus"
df_habitat[which(df_habitat$species == "invalidus 2"),] <- "invalidus"

df_habitat[which(df_habitat$species == "sculpturatus 1"),] <- "sculpturatus"
df_habitat[which(df_habitat$species == "sculpturatus 2"),] <- "sculpturatus"
df_habitat[which(df_habitat$species == "sculpturatus 3"),] <- "sculpturatus"

df_habitat[which(df_habitat$species == "wolfi 1"),] <- "wolfi"
df_habitat[which(df_habitat$species == "wolfi 2"),] <- "wolfi"
df_habitat[which(df_habitat$species == "wolfi 3"),] <- "wolfi"

df_habitat[which(df_habitat$species == "cf. perspectivus"),] <- "perspectivus"
df_habitat[which(df_habitat$species == "perspectivus 1"),] <- "perspectivus"
df_habitat[which(df_habitat$species == "perspectivus 2"),] <- "perspectivus"

df_habitat[which(df_habitat$species == "cf. amastroides"),] <- "amastroides"

df_habitat[which(df_habitat$species == "canaliferus 1"),] <- "canaliferus"
df_habitat[which(df_habitat$species == "canaliferus 2"),] <- "canaliferus"

df_habitat[which(df_habitat$species == "simrothi 1"),] <- "simrothi"
df_habitat[which(df_habitat$species == "simrothi 2"),] <- "simrothi"

df_habitat[which(df_habitat$species == "cf. tortuganus"),] <- "tortuganus"

df_habitat[which(df_habitat$species == "cf. nux"),] <- "nux"

```


Only keep species with assessed load:

```{r}

df_habitat1 <- df_habitat

# Filter df_merged to only include species that appear in df_load
df_habitat <- df_habitat %>%
  semi_join(df_load, by = "species")

df_habitat
```


which species were discarded?

```{r}
discarded_species <- setdiff(unique(df_habitat1$species), unique(df_habitat$species))
discarded_species
```

**df_habitat** is the data from which the mean_habitat will be modeled for each species

**df_load** is the data from which nematode counts are modeled.


### Create common species code to make sure species names coincide

```{r}

# Combine unique species from both dataframes
unique_species <- unique(c(unique(df_load$species), unique(df_habitat$species)))

# Create a dictionary of species to letters
species_to_number <- setNames(1:length(unique_species), unique_species)

# Add the letter codes to df_load and df_habitat
df_load$species_code <- species_to_number[df_load$species]
df_habitat$species_code <- species_to_number[df_habitat$species]

# View the updated dataframes
df_load
df_habitat
```




# brightness data

```{r}
df_kraemer <- read.csv("kraemer2019/kraemer2019_brightness_scores.csv")

df_kraemer <- df_kraemer %>% 
  select(location, spp, brightness) %>% 
  rename(id = location,
         species = spp)

df_kraemer

```


Names checks

```{r}
df_kraemer[which(df_kraemer$species == "albermarlensis"),] <- "albemarlensis"
df_kraemer[which(df_kraemer$species == "cf. albemarlensis"),] <- "albemarlensis"

df_kraemer[which(df_kraemer$species == "ustulatus pallescens"),] <- "ustulatus"
df_kraemer[which(df_kraemer$species == "ustulatus phlegonis"),] <- "ustulatus"
df_kraemer[which(df_kraemer$species == "ustulatus mahogany"),] <- "ustulatus"

df_kraemer[which(df_kraemer$species == "invalidus 1"),] <- "invalidus"
df_kraemer[which(df_kraemer$species == "invalidus 2"),] <- "invalidus"

df_kraemer[which(df_kraemer$species == "sculpturatus 1"),] <- "sculpturatus"
df_kraemer[which(df_kraemer$species == "sculpturatus 2"),] <- "sculpturatus"
df_kraemer[which(df_kraemer$species == "sculpturatus 3"),] <- "sculpturatus"

df_kraemer[which(df_kraemer$species == "wolfi 1"),] <- "wolfi"
df_kraemer[which(df_kraemer$species == "wolfi 2"),] <- "wolfi"
df_kraemer[which(df_kraemer$species == "wolfi 3"),] <- "wolfi"

df_kraemer[which(df_kraemer$species == "cf. perspectivus"),] <- "perspectivus"
df_kraemer[which(df_kraemer$species == "perspectivus 1"),] <- "perspectivus"
df_kraemer[which(df_kraemer$species == "perspectivus 2"),] <- "perspectivus"

df_kraemer[which(df_kraemer$species == "cf. amastroides"),] <- "amastroides"

df_kraemer[which(df_kraemer$species == "canaliferus 1"),] <- "canaliferus"
df_kraemer[which(df_kraemer$species == "canaliferus 2"),] <- "canaliferus"

df_kraemer[which(df_kraemer$species == "simrothi 1"),] <- "simrothi"
df_kraemer[which(df_kraemer$species == "simrothi 2"),] <- "simrothi"

df_kraemer[which(df_kraemer$species == "cf. tortuganus"),] <- "tortuganus"

df_kraemer[which(df_kraemer$species == "cf. nux"),] <- "nux"
```


Only keep species with assessed load:

```{r}

df_kraemer1 <- df_kraemer

# df_kraemer df_merged to only include species that appear in df_load
df_kraemer <- df_kraemer %>%
  semi_join(df_load, by = "species")

df_kraemer
```
which species were discarded?

```{r}
discarded_species <- setdiff(unique(df_kraemer1$species), unique(df_kraemer$species))
discarded_species
```


### Create common species code to make sure species names coincide

```{r}

# Combine unique species from both dataframes
unique_species <- unique(c(unique(df_load$species), unique(df_kraemer$species)))

# Create a dictionary of species to letters
species_to_number <- setNames(1:length(unique_species), unique_species)

# Add the letter codes to df_load and df_habitat
df_load$species_code <- species_to_number[df_load$species]
df_kraemer$species_code <- species_to_number[df_kraemer$species]

# View the updated dataframes
df_load
df_kraemer
```



# MODEL STAN: load ~ brightness

Input data

```{r}
data_list <- list(
  N_nem = nrow(df_load),
  N_bright = nrow(df_kraemer),
  N_sp_nem = length(unique(df_load$species)),
  N_sp_bright = length(unique(df_kraemer$species)),
  
  load = df_load$nematode_count,
  brightness = as.numeric(df_kraemer$brightness),
  
  species_i = df_load$species_code,
  species_k = df_kraemer$species_code
)

```



```{r}
stan_load_brightness <- cmdstan_model(
  stan_file = "load_brightness.stan", 
  pedantic = TRUE)

stan_load_brightness
```

















-----------------------------------------------------------------------------------


# Brightness, habitat, island characteristics

```{r}
# brightness
df_kraemer <- read.csv("kraemer2019/kraemer2019_brightness_scores.csv")

# habitat
df_microhab <- read_excel("04april24_datalab.xlsx", sheet = "spp_mynames_features")

#island

df_island <- read_excel("04april24_datalab.xlsx", sheet = "island_characteristics")
```




# shell brightness

```{r}

df_kraemer <- df_kraemer %>% 
  select(spp, brightness)

df_brightness <- df_kraemer %>%
  group_by(spp) %>%
  summarise(
    mean_brightness = mean(brightness, na.rm = TRUE),
    sd_brightness = sd(brightness, na.rm = TRUE)
  )


df_brightness

```




### Load vs brightness (individual data for load)


```{r}

df_load <- df_load %>% 
  rename(spp = species)

df_combined <- df_load %>%
  left_join(df_brightness, by = "spp")

df_combined

```



```{r}
# Compute summary statistics for df_load
df_load_indiv <- df %>%
  group_by(spp) %>%
  summarise(n = n(),
            mean_load = mean(nematode_count, na.rm = TRUE),
            sd_load = sd(nematode_count, na.rm = TRUE)) %>%
  arrange(desc(mean_load))

# Merge df with df_brightness to get mean_brightness and sd_brightness
df_combined <- df %>%
  left_join(df_brightness, by = "spp")

# Merge df_combined with df_load to get mean_load and sd_load for each species
df_combined <- df_combined %>%
  left_join(df_load_indiv, by = "spp")

plot_brighness_load <- ggplot(df_combined, aes(x = mean_brightness, y = nematode_count)) +
  geom_jitter(width = 0.2, alpha = 0.4) + # Jittered points for distribution
  stat_summary(aes(y = mean_load), fun = mean, geom = "point", color = "red", size = 3) + # Mean points
  stat_summary(aes(y = mean_load), fun.data = mean_sdl, fun.args = list(mult = 1), geom = "errorbar", width = 0.2, color = "red") + # Error bars
  geom_smooth(method = "gam", se = FALSE, linetype = "dashed",color = "blue") + # Add tendency line
  labs(x = "Mean shell brightness",
       y = "Nematode count") +
  theme_bw() +
  my_theme

ggplot(df_combined, aes(x = mean_brightness, y = mean_load)) +
  geom_jitter(width = 0.2, alpha = 0.4) + # Jittered points for distribution
  stat_summary(aes(y = mean_load), fun = mean, geom = "point", color = "red", size = 3) + # Mean points
  stat_summary(aes(y = mean_load), fun.data = mean_sdl, fun.args = list(mult = 1), geom = "errorbar", width = 0.2, color = "red") + # Error bars
  geom_smooth(method = "lm", se = FALSE, linetype = "dashed",color = "blue") + # Add tendency line
  labs(x = "Mean shell brightness",
       y = "Nematode count") +
  theme_bw() +
  my_theme

plot_brighness_load

ggsave("figures/brightness_load.png", height = 8, width = 7)
```


```{r}


colnames(df_load)[1] <- "species"
colnames(df_brightness)[1] <- "species"
# Merge df_load with df_brightness based on species
combined_df <- left_join(df_load, df_brightness, by = "species")

colnames(df_microhab)[1] <- "species"

# Merge combined_df with df_microhab based on additional common columns
combined_df <- left_join(combined_df, df_microhab, by = c("species"))

combined_df
```


```{r}

df <- df %>%
  rename(species = spp)

# Step 1: Add the island name corresponding to each species in combined_df
combined_df <- combined_df %>%
  left_join(df %>%
              distinct(species, island), by = "species")

# Step 2: Merge combined_df with df_island based on the island name
combined_df <- combined_df %>%
  left_join(df_island, by = c("island" = "island"))

# Step 3: Create the new columns "island_age" and "island_area" in combined_df
combined_df <- combined_df %>%
  mutate(island_age = mean_emergence,
         island_area = area)

combined_df <- combined_df[-nrow(combined_df),]

combined_df

```


PLOTS

```{r}
back_transform_sqrt <- function(x) {
  return(x^2)  # Square back the transformed value
}
```


```{r}
# (1) Boxplot of mean_load in function of microhabitat
boxplot_microhabitat <- ggplot(combined_df %>% filter(!is.na(microhabitat)), aes(x = microhabitat, y = mean_load)) +
  geom_boxplot() +
  geom_point(position = position_jitter(width = 0.1), alpha = 0.5) +  # Add points with jitter
  labs(
       x = NULL,
       y = "Mean nematode load") +
  theme_bw() +
  my_theme

# (2) Boxplot of mean_load in function of vegetation zone (excluding NA values)
boxplot_vegetation <- ggplot(combined_df %>% filter(!is.na(vegetation_zone)), aes(x = vegetation_zone, y = mean_load)) +
  geom_boxplot() +
  geom_point(position = position_jitter(width = 0.1), alpha = 0.5) +  # Add points with jitter
  labs(
       x = NULL,
       y = "Mean nematode load") +
  theme_bw() +
  my_theme

# (3) Plot of mean_load in function of island age
plot_island_age <- ggplot(combined_df, aes(x = island_age, y = mean_load)) +
  geom_point() +
  labs(
       x = "Island age",
       y = "Mean nematodes load")+
  theme_bw()+
  my_theme

# (4) Plot of mean_load in function of island size
plot_island_size <- ggplot(combined_df, aes(x = sqrt(island_area), y = mean_load)) +
  geom_point() +
  labs(
       x = expression("Island area ("~km^2~")"),
       y = "Mean nematode load") +
  scale_x_continuous(labels = back_transform_sqrt) +
  theme_bw() +
  my_theme



# Combine the plots using ggarrange
combined_plot <- ggarrange(boxplot_microhabitat, 
                           boxplot_vegetation + ylab(""), 
                           plot_island_age, 
                           plot_island_size + ylab(""),
                           ncol = 2, nrow = 2,
                           labels = LETTERS[1:4])

combined_plot

#ggsave("figures/load_habitat_island.png", height = 9, width = 8)
```


```{r}

# Calculate the mean load for each island
mean_load_by_island <- combined_df %>%
  group_by(island) %>%
  summarize(mean_load = mean(mean_load, na.rm = TRUE))

# Reorder the islands based on the mean load value
ordered_islands <- mean_load_by_island %>%
  arrange(desc(mean_load)) %>%
  pull(island)

# Plot with x-axis categories ordered by mean_load value
plot_island_name <- ggplot(combined_df, aes(x = factor(island, levels = ordered_islands), y = mean_load)) +
  geom_boxplot() +
  geom_point(position = position_jitter(width = 0.2), alpha = 0.5, size = 2) +  # Add points with jitter
  labs(
       x = NULL,
       y = "Mean nematodes load") +
  theme_bw() +
  my_theme +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

plot_island_name

#ggsave("figures/load_islandname.png", height = 7, width = 8)

```


## tests

```{r}

combined_df

```




# Phylogenetic distance


```{r}
# Read the .nwk file
tree <- read.tree("phylogeny_2022/22Nov_Naesiotus.nwk")
data <- read.nexus("phylogeny_2022/22Nov_Naesiotus.nex")
df_rads <- read_excel("GPS RAD snails.xlsx")

plot(tree)
```


```{r}
# Create a mapping between Sample and Taxon
sample_to_taxon <- setNames(df_rads$Taxon, df_rads$Sample)

# Replace tip labels in the tree with corresponding taxa
tree$tip.label <- sample_to_taxon[tree$tip.label]

plot(tree)
```


compute phylogenetic distances

```{r}
phylo_dist_matrix <- cophenetic.phylo(tree)

```


```{r}
df_load
```

```{r}
# Step 1: Calculate pairwise distances of mean_load values
load_dist_matrix <- as.matrix(dist(df_load$mean_load, method = "euclidean"))
rownames(load_dist_matrix) <- df_load$species
colnames(load_dist_matrix) <- df_load$species

# Step 2: Check and match species names in both matrices
common_species <- intersect(rownames(load_dist_matrix), rownames(phylo_dist_matrix))

common_species <- common_species[!is.na(common_species)]

# Step 3: Subset and reorder matrices
load_dist_matrix_subset <- load_dist_matrix[common_species, common_species]
phylo_dist_matrix_subset <- phylo_dist_matrix[common_species, common_species]

# Step 4: convert into distance objects
load_dist <- as.dist(load_dist_matrix_subset)
phylo_dist <- as.dist(phylo_dist_matrix_subset)

# Step 5: compute an ordination of the matrices

load_pco <- dudi.pco(load_dist, scannf = FALSE, nf = 2, full = TRUE)
phylo_pco <- dudi.pco(phylo_dist, scannf = FALSE, nf = 2, full = TRUE)

```

PCO plots

```{r}
# Create a data frame for ggplot2 (example for load_pco)
load_pco_data <- data.frame(Species = rownames(load_pco$li), 
                            PCoA1 = load_pco$li[, 1])

# Plot using ggplot2
ggplot(load_pco_data, aes(x = Species, y = PCoA1)) +
  geom_bar(stat = "identity", fill = "blue") +
  labs(title = "Principal Coordinate Analysis (PCoA) of Nematode Load", 
       x = "Species", y = "PCoA 1") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

Procrustes

```{r}
protest <- protest(load_pco, phylo_pco)
protest

plot(protest)
```



## models test

```{r}
combined_df
```



```{r}

```










```{r}
# Convert categorical variables to factors
combined_df$microhabitat <- as.factor(combined_df$microhabitat)
combined_df$vegetation_zone <- as.factor(combined_df$vegetation_zone)

# Define priors
fixed_effects_prior <- set_prior("normal(0, 5)", class = "b")
random_effects_prior <- set_prior("cauchy(0, 2)", class = "sd")

# Fit the Bayesian model
bayesian_model <- brm(mean_load ~ microhabitat + vegetation_zone + mean_emergence + area + mean_brightness + (1|species),
                      data = combined_df, 
                      family = gaussian(),
                      prior = c(fixed_effects_prior, random_effects_prior),
                      chains = 4, iter = 2000, warmup = 1000, cores = 4,
                      control = list(adapt_delta = 0.95))

# Summarize the model
summary(bayesian_model)

# Get the marginal effects
marginal_effects <- marginal_effects(bayesian_model)

# Plot the marginal effects
plot(marginal_effects)
```

