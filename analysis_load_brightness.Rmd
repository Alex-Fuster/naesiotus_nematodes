---
title: "Load ~ brightness"
---

```{r}
library(dplyr)
library(ggplot2)# Load the ape package
library(ape)
library(readxl)
library(tidyr)
library(ggpubr)
library(ade4)
library(vegan)
library(stringr)
library(brms)
library(dplyr)
library(tidyverse)
library(cmdstanr)
library(bayesplot)
```


# Load dataset


```{r}
df_load <- read_excel("04april24_datalab.xlsx", sheet = 3)
df_load$nematode_count[which(df_load$nematode_count == ">100")] <- "100"
df_load$nematode_count <- as.numeric(df_load$nematode_count)

df_load <- df_load %>% 
  select(id, spp, nematode_count) %>% 
  rename(species = spp)

df_load
```



### df mean load


```{r}

df_meanload <- df_load %>%
  group_by(species) %>%
  summarise(n = n(),
            mean_load = mean(nematode_count, na.rm = TRUE),
            sd_load = sd(nematode_count, na.rm = TRUE)) %>%
  arrange(desc(mean_load))

colnames(df_meanload) = c("species", "n" ,"mean_load", "sd_load")

df_totals <- data.frame("n" = sum(df_meanload$n),
           "mean_load" = mean(df_meanload$mean_load),
           "sd_load" = mean(df_meanload$sd_load))

df_meanload <- bind_rows(df_meanload, df_totals)

df_meanload$mean_load <- round(df_meanload$mean_load, 1)
df_meanload$sd_load <- round(df_meanload$sd_load, 1)

df_meanload

#write.csv(df_load, "output/df_load.csv")

```



# brightness data

```{r}
df_kraemer <- read.csv("kraemer2019/kraemer2019_brightness_scores.csv")

df_kraemer <- df_kraemer %>% 
  select(location, spp, brightness) %>% 
  rename(id = location,
         species = spp)

df_kraemer

```


Names checks

```{r}
df_kraemer[which(df_kraemer$species == "albermarlensis"),"species"] <- "albemarlensis"
df_kraemer[which(df_kraemer$species == "cf. albemarlensis"),"species"] <- "albemarlensis"

df_kraemer[which(df_kraemer$species == "ustulatus pallescens"),"species"] <- "ustulatus"
df_kraemer[which(df_kraemer$species == "ustulatus phlegonis"),"species"] <- "ustulatus"
df_kraemer[which(df_kraemer$species == "ustulatus mahogany"),"species"] <- "ustulatus"

df_kraemer[which(df_kraemer$species == "invalidus 1"),"species"] <- "invalidus"
df_kraemer[which(df_kraemer$species == "invalidus 2"),"species"] <- "invalidus"

df_kraemer[which(df_kraemer$species == "sculpturatus 1"),"species"] <- "sculpturatus"
df_kraemer[which(df_kraemer$species == "sculpturatus 2"),"species"] <- "sculpturatus"
df_kraemer[which(df_kraemer$species == "sculpturatus 3"),"species"] <- "sculpturatus"

df_kraemer[which(df_kraemer$species == "wolfi 1"),"species"] <- "wolfi"
df_kraemer[which(df_kraemer$species == "wolfi 2"),"species"] <- "wolfi"
df_kraemer[which(df_kraemer$species == "wolfi 3"),"species"] <- "wolfi"

df_kraemer[which(df_kraemer$species == "cf. perspectivus"),"species"] <- "perspectivus"
df_kraemer[which(df_kraemer$species == "perspectivus 1"),"species"] <- "perspectivus"
df_kraemer[which(df_kraemer$species == "perspectivus 2"),"species"] <- "perspectivus"

df_kraemer[which(df_kraemer$species == "cf. amastroides"),"species"] <- "amastroides"

df_kraemer[which(df_kraemer$species == "canaliferus 1"),"species"] <- "canaliferus"
df_kraemer[which(df_kraemer$species == "canaliferus 2"),"species"] <- "canaliferus"

df_kraemer[which(df_kraemer$species == "simrothi 1"),"species"] <- "simrothi"
df_kraemer[which(df_kraemer$species == "simrothi 2"),"species"] <- "simrothi"

df_kraemer[which(df_kraemer$species == "cf. tortuganus"),"species"] <- "tortuganus"

df_kraemer[which(df_kraemer$species == "cf. nux"),"species"] <- "nux"
```


Only keep species with assessed load:

```{r}

df_kraemer1 <- df_kraemer

# df_kraemer df_merged to only include species that appear in df_load
df_kraemer <- df_kraemer %>%
  semi_join(df_load, by = "species")

df_kraemer
```



### Create common species code to make sure species names coincide

```{r}

# Combine unique species from both dataframes
unique_species <- unique(c(unique(df_load$species), unique(df_kraemer$species)))

# Create a dictionary of species to letters
species_to_number <- setNames(1:length(unique_species), unique_species)

# Add the letter codes to df_load and df_habitat
df_load$species_code <- species_to_number[df_load$species]
df_kraemer$species_code <- species_to_number[df_kraemer$species]


df_load
df_kraemer
```



# MODEL STAN: load ~ brightness

Input data

```{r}
data_list <- list(
  N_nem = nrow(df_load),
  N_bright = nrow(df_kraemer),
  N_sp_nem = length(unique(df_load$species)),
  N_sp_bright = length(unique(df_kraemer$species)),
  
  load = df_load$nematode_count,
  brightness = df_kraemer$brightness,
  
  species_i = unname(df_load$species_code),
  species_k = df_kraemer$species_code
)

```



```{r}
# Create a mapping between species names and new IDs for df_kraemer
kraemer_species <- unique(df_kraemer$species)
kraemer_species_map <- setNames(seq_along(kraemer_species), kraemer_species)

# Create a mapping between species names and new IDs for df_load
load_species <- unique(df_load$species)
load_species_map <- setNames(seq_along(load_species), load_species)

# Create the species_map that maps df_load species IDs to df_kraemer species IDs
species_map <- sapply(load_species, function(x) {
  if (x %in% kraemer_species) {
    kraemer_species_map[x]
  } else {
    NA
  }
})

# Remove species in df_load that do not have corresponding entries in df_kraemer
valid_species <- !is.na(species_map)
df_load_filtered <- df_load[df_load$species %in% names(species_map)[valid_species], ]

# Recreate species_map with only valid species
species_map <- species_map[valid_species]

# Create the new species IDs for df_load and df_kraemer
df_load_filtered$new_species_id <- load_species_map[df_load_filtered$species]
df_kraemer$new_species_id <- kraemer_species_map[df_kraemer$species]

# Update species names to be unique in species_map
names(species_map) <- sub("\\..*", "", names(species_map))

data_list <- list(
  N_nem = nrow(df_load_filtered),
  N_bright = nrow(df_kraemer),
  N_sp_nem = length(unique(df_load_filtered$species)),
  N_sp_bright = length(unique(df_kraemer$species)),
  load = df_load_filtered$nematode_count,
  brightness = df_kraemer$brightness,
  species_i = df_load_filtered$new_species_id,
  species_k = df_kraemer$new_species_id,
  species_map = as.integer(species_map)
)

# Fit the model using cmdstanr
stan_load_brightness <- cmdstan_model(
  stan_file = "load_brightness.stan", 
  pedantic = TRUE
)

fit <- stan_load_brightness$sample(
  data = data_list,
  seed = 123,             
  chains = 4,               
  parallel_chains = 4,    
  iter_warmup = 1000,       
  iter_sampling = 2000   
)




```



# Plotting results


```{r}
stan_load_brightness |> tidybayes::gather_rvars(predicted_load[i])
```



## Posterior vs predicted

```{r}

# Calculate observed means
observed_means <- df_load %>%
  group_by(species_code) %>%
  summarise(observed_mean_load = mean(nematode_count))

# Calculate predicted means


# Merge observed and predicted means for comparison
comparison <- merge(observed_means, predicted_means, by = "species_code")

# Plot comparison
library(ggplot2)

ggplot(comparison, aes(x = observed_mean_load, y = predicted_mean_load)) +
  geom_point(color = "blue") +
  geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "red") +
  labs(x = "Observed Mean Load", y = "Predicted Mean Load", 
       title = "Comparison of Observed and Predicted Mean Load") +
  theme_minimal()

```



## All posterior pars

```{r}
# Extract the posterior samples
posterior_samples <- fit$draws()

# Convert to a data frame for easier handling
posterior_df <- as_draws_df(posterior_samples)

# Rename mu_bright parameters for easier handling
posterior_df <- posterior_df %>%
  rename_with(~ gsub("\\[|\\]", "", .), starts_with("mu_bright")) %>%
  rename_with(~ gsub("\\.", "_", .), starts_with("mu_bright"))

# Extract the names of the parameters of interest
mu_bright_names <- grep("^mu_bright", names(posterior_df), value = TRUE)
sigma_bright_names <- grep("^sigma_bright", names(posterior_df), value = TRUE)

parameter_names <- c("intercept", "slope_bright", mu_bright_names, sigma_bright_names)
```


```{r}
# Plot posterior distributions of the parameters
mcmc_areas(
  posterior_df,
  pars = parameter_names,
  prob = 0.8  # 80% intervals
)


```
### Posterior brightness slope

```{r}
# Extract the posterior samples of the slope of brightness
slope_samples <- fit$draws("slope_bright")

# Plot the posterior distribution of the slope of brightness
mcmc_hist(slope_samples, prob = 0.8)

```



```{r}
fit$draws(variables = c("intercept", "slope_bright")) |>
  posterior::summarise_draws("mean", "sd", ~quantile(.x, probs = c(0.05, 0.95)), "rhat") #|>
  #flextable::flextable()
```


### Plot for predicted values


```{r}

```








---------------------------------

### Relationship load-brightness

```{r}
# Calculate mean brightness for each species from the posterior samples
mu_bright_mean <- posterior_df %>%
  summarise(across(all_of(mu_bright_names), mean)) %>%
  unlist()

# Create a data frame with species IDs and corresponding mean brightness
brightness_df <- data.frame(
  species_id = seq_along(mu_bright_mean),
  mu_bright = mu_bright_mean
)

# Calculate the mean intercept and slope from the posterior samples
intercept_mean <- mean(posterior_df$intercept)
slope_bright_mean <- mean(posterior_df$slope_bright)

# Create a data frame with the species mean parasitic load
mean_parasitic_load <- df_load %>%
  group_by(species_code) %>%
  summarise(mean_load = mean(nematode_count))

# Merge brightness and parasitic load data frames
plot_df <- merge(brightness_df, mean_parasitic_load, by.x = "species_id", by.y = "species_code")

# Plot the relationship
ggplot(plot_df, aes(x = mu_bright, y = mean_load)) +
  geom_point() +
  geom_abline(intercept = intercept_mean, slope = slope_bright_mean, color = "blue") +
  labs(x = "Mean Brightness", y = "Mean Parasitic Load") +
  theme_minimal()



```


