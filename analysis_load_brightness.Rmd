---
title: "Load ~ brightness"
---

```{r}
library(dplyr)
library(ggplot2)# Load the ape package
library(ape)
library(readxl)
library(tidyr)
library(ggpubr)
library(ade4)
library(vegan)
library(stringr)
library(brms)
library(dplyr)
library(tidyverse)
library(cmdstanr)
```


# Load dataset


```{r}
df_load <- read_excel("04april24_datalab.xlsx", sheet = 3)
df_load$nematode_count[which(df_load$nematode_count == ">100")] <- "100"
df_load$nematode_count <- as.numeric(df_load$nematode_count)

df_load <- df_load %>% 
  select(id, spp, nematode_count) %>% 
  rename(species = spp)

df_load
```



### df mean load


```{r}

df_meanload <- df_load %>%
  group_by(species) %>%
  summarise(n = n(),
            mean_load = mean(nematode_count, na.rm = TRUE),
            sd_load = sd(nematode_count, na.rm = TRUE)) %>%
  arrange(desc(mean_load))

colnames(df_meanload) = c("species", "n" ,"mean_load", "sd_load")

df_totals <- data.frame("n" = sum(df_meanload$n),
           "mean_load" = mean(df_meanload$mean_load),
           "sd_load" = mean(df_meanload$sd_load))

df_meanload <- bind_rows(df_meanload, df_totals)

df_meanload$mean_load <- round(df_meanload$mean_load, 1)
df_meanload$sd_load <- round(df_meanload$sd_load, 1)

df_meanload

#write.csv(df_load, "output/df_load.csv")

```



# brightness data

```{r}
df_kraemer <- read.csv("kraemer2019/kraemer2019_brightness_scores.csv")

df_kraemer <- df_kraemer %>% 
  select(location, spp, brightness) %>% 
  rename(id = location,
         species = spp)

df_kraemer

```


Names checks

```{r}
df_kraemer[which(df_kraemer$species == "albermarlensis"),"species"] <- "albemarlensis"
df_kraemer[which(df_kraemer$species == "cf. albemarlensis"),"species"] <- "albemarlensis"

df_kraemer[which(df_kraemer$species == "ustulatus pallescens"),"species"] <- "ustulatus"
df_kraemer[which(df_kraemer$species == "ustulatus phlegonis"),"species"] <- "ustulatus"
df_kraemer[which(df_kraemer$species == "ustulatus mahogany"),"species"] <- "ustulatus"

df_kraemer[which(df_kraemer$species == "invalidus 1"),"species"] <- "invalidus"
df_kraemer[which(df_kraemer$species == "invalidus 2"),"species"] <- "invalidus"

df_kraemer[which(df_kraemer$species == "sculpturatus 1"),"species"] <- "sculpturatus"
df_kraemer[which(df_kraemer$species == "sculpturatus 2"),"species"] <- "sculpturatus"
df_kraemer[which(df_kraemer$species == "sculpturatus 3"),"species"] <- "sculpturatus"

df_kraemer[which(df_kraemer$species == "wolfi 1"),"species"] <- "wolfi"
df_kraemer[which(df_kraemer$species == "wolfi 2"),"species"] <- "wolfi"
df_kraemer[which(df_kraemer$species == "wolfi 3"),"species"] <- "wolfi"

df_kraemer[which(df_kraemer$species == "cf. perspectivus"),"species"] <- "perspectivus"
df_kraemer[which(df_kraemer$species == "perspectivus 1"),"species"] <- "perspectivus"
df_kraemer[which(df_kraemer$species == "perspectivus 2"),"species"] <- "perspectivus"

df_kraemer[which(df_kraemer$species == "cf. amastroides"),"species"] <- "amastroides"

df_kraemer[which(df_kraemer$species == "canaliferus 1"),"species"] <- "canaliferus"
df_kraemer[which(df_kraemer$species == "canaliferus 2"),"species"] <- "canaliferus"

df_kraemer[which(df_kraemer$species == "simrothi 1"),"species"] <- "simrothi"
df_kraemer[which(df_kraemer$species == "simrothi 2"),"species"] <- "simrothi"

df_kraemer[which(df_kraemer$species == "cf. tortuganus"),"species"] <- "tortuganus"

df_kraemer[which(df_kraemer$species == "cf. nux"),"species"] <- "nux"
```


Only keep species with assessed load:

```{r}

df_kraemer1 <- df_kraemer

# df_kraemer df_merged to only include species that appear in df_load
df_kraemer <- df_kraemer %>%
  semi_join(df_load, by = "species")

df_kraemer
```



### Create common species code to make sure species names coincide

```{r}

# Combine unique species from both dataframes
unique_species <- unique(c(unique(df_load$species), unique(df_kraemer$species)))

# Create a dictionary of species to letters
species_to_number <- setNames(1:length(unique_species), unique_species)

# Add the letter codes to df_load and df_habitat
df_load$species_code <- species_to_number[df_load$species]
df_kraemer$species_code <- species_to_number[df_kraemer$species]


df_load
df_kraemer
```



# MODEL STAN: load ~ brightness

Input data

```{r}
data_list <- list(
  N_nem = nrow(df_load),
  N_bright = nrow(df_kraemer),
  N_sp_nem = length(unique(df_load$species)),
  N_sp_bright = length(unique(df_kraemer$species)),
  
  load = df_load$nematode_count,
  brightness = df_kraemer$brightness,
  
  species_i = df_load$species_code,
  species_k = df_kraemer$species_code
)

```



```{r}
stan_load_brightness <- cmdstan_model(
  stan_file = "load_brightness.stan", 
  pedantic = TRUE)

```


```{r}

# Fit the model using the data
fit <- stan_load_brightness$sample(
  data = data_list,
  seed = 123,               # for reproducibility
  chains = 4,               # number of Markov chains
  parallel_chains = 4,      # number of parallel chains
  iter_warmup = 1000,       # number of warm-up iterations per chain
  iter_sampling = 2000      # number of sampling iterations per chain
)

```

